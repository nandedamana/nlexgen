CFLAGS=-Wall -std=c99 -DNLEX_ITSELF
DEBUGFLAGS=-DDEBUG -g
OBJS=error.o plot.o main.o read.o tree.o tree_types.o

ifdef nlxdebug
	debug = 1
  CFLAGS += -D NLXDEBUG
endif

# Use `make clean; make debug=1` to turn on the debug mode.
ifdef debug
  CFLAGS += $(DEBUGFLAGS)
else
  CFLAGS += -O3 -s
endif

default:nlexgen

error.c: errmap.tsv error.c.top
	cp error.c.top error.c
	awk -F "\t" '{print "const char * "$$1" = "$$2";"}' errmap.tsv >> error.c

error.h: errmap.tsv error.h.top
	cp error.h.top error.h
	awk -F "\t" '{print "extern const char * "$$1";"}' errmap.tsv >> error.h
	echo '#endif' >> error.h

tree_types.h: tree_types.c

tree_types.c: tree_types.ngg
	ngg -oh tree_types.h -oc tree_types.c --c-include-guard _N96E_LEX_TREE_TYPES_H tree_types.ngg

types.h: types.ngg
	ngg -oh types.h -oc /dev/null --c-include-guard _N96E_LEX_TYPES_H types.ngg

# Some .h files are explicitly specified because they are generated by some
# other rules and the expansion of '*.h' won't include them unless those
# rules are executed at least once.
%.o: %.c *.h tree_types.h types.h error.h
	cc $(CFLAGS) -c $<

nlexgen:$(OBJS)
	cc $(CFLAGS) -o nlexgen $(OBJS)

clean:
	rm -f nlexgen *.o error.[ch] types.h tree_types.[ch]
